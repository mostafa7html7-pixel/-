<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة مستر حمدي الاحترافية v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #videoContainer { position: relative; background: #000; border-radius: 15px; overflow: hidden; }
        #cameraOverlay { position: absolute; bottom: 10px; right: 10px; width: 150px; border: 2px solid #3b82f6; border-radius: 10px; z-index: 20; }
        #whiteboard { position: absolute; top: 0; left: 0; z-index: 10; cursor: crosshair; touch-action: none; }
        .tool-btn { padding: 8px; border-radius: 8px; transition: 0.3s; }
        .tool-btn:hover { background: #334155; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">

    <div class="container mx-auto px-4 py-4">
        <div class="flex justify-between items-center bg-slate-800 p-4 rounded-xl border border-slate-700 mb-4">
            <h1 class="text-xl font-bold text-blue-400">H-Live <span class="text-white text-xs font-light">بث + كاميرا + سبورة</span></h1>
            <div id="status" class="px-3 py-1 rounded-full bg-red-500 text-[10px] animate-pulse">غير متصل</div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
            <div class="lg:col-span-4 space-y-4">
                <div id="videoContainer" class="aspect-video shadow-2xl border border-slate-700">
                    <video id="mainVideo" autoplay playsinline class="w-full h-full object-contain"></video>
                    <video id="cameraOverlay" autoplay playsinline muted></video>
                    <canvas id="whiteboard" class="w-full h-full"></canvas>
                </div>

                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex gap-2 items-center">
                        <button id="startTeacher" class="bg-blue-600 px-4 py-2 rounded-lg font-bold text-sm">أنا المستر</button>
                        <button id="startStudent" class="bg-purple-600 px-4 py-2 rounded-lg font-bold text-sm">أنا طالب</button>
                    </div>

                    <div id="drawingTools" class="hidden flex gap-3 items-center border-r border-slate-600 pr-4">
                        <input type="color" id="colorPicker" class="w-8 h-8 rounded cursor-pointer bg-transparent">
                        <button id="clearBoard" class="text-red-400 hover:text-red-300 text-sm font-bold">مسح السبورة</button>
                    </div>

                    <button id="stopSession" class="bg-red-600 px-6 py-2 rounded-lg font-bold text-sm hidden">إنهاء وحفظ</button>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-4">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 h-full">
                    <h3 class="font-bold text-blue-300 text-sm mb-4">الطلاب النشطين</h3>
                    <ul id="userList" class="text-xs space-y-2 opacity-50 italic">
                        <li>في انتظار دخول الطلاب...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcFRLMsewcgYXYgVvdkyQHf-imoJHHzng",
            authDomain: "mrhamdy-1c406.firebaseapp.com",
            databaseURL: "https://mrhamdy-1c406-default-rtdb.firebaseio.com",
            projectId: "mrhamdy-1c406",
            storageBucket: "mrhamdy-1c406.firebasestorage.app",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        const canvas = document.getElementById('whiteboard');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let isTeacher = false;

        // ضبط مقاس السبورة
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        window.onresize = resizeCanvas;
        resizeCanvas();

        // --- كود الرسم (للمستر فقط) ---
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);

        function startDrawing(e) {
            if (!isTeacher) return;
            isDrawing = true;
            draw(e);
        }

        function draw(e) {
            if (!isDrawing || !isTeacher) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / canvas.width;
            const y = (e.clientY - rect.top) / canvas.height;
            const color = document.getElementById('colorPicker').value;

            // إرسال الإحداثيات لـ Firebase
            push(ref(db, 'whiteboard/points'), { x, y, color, type: 'draw' });
        }

        function stopDrawing() {
            if (!isTeacher) return;
            isDrawing = false;
            push(ref(db, 'whiteboard/points'), { type: 'stop' });
        }

        document.getElementById('clearBoard').onclick = () => {
            remove(ref(db, 'whiteboard/points'));
        };

        // --- استقبال الرسم (للجميع) ---
        onValue(ref(db, 'whiteboard/points'), (snapshot) => {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // مسح للرسم من جديد (للبساطة)
            const data = snapshot.val();
            if (data) {
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                let lastPoint = null;

                Object.values(data).forEach(p => {
                    if (p.type === 'stop') {
                        lastPoint = null;
                        return;
                    }
                    ctx.strokeStyle = p.color;
                    ctx.beginPath();
                    if (lastPoint) {
                        ctx.moveTo(lastPoint.x * canvas.width, lastPoint.y * canvas.height);
                        ctx.lineTo(p.x * canvas.width, p.y * canvas.height);
                        ctx.stroke();
                    }
                    lastPoint = p;
                });
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        });

        // --- منطق البث (WebRTC كما سبق) ---
        let pc;
        document.getElementById('startTeacher').onclick = async () => {
            isTeacher = true;
            document.getElementById('drawingTools').classList.remove('hidden');
            document.getElementById('stopSession').classList.remove('hidden');
            
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            const cameraStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

            document.getElementById('mainVideo').srcObject = screenStream;
            document.getElementById('cameraOverlay').srcObject = cameraStream;
            document.getElementById('status').innerText = "بث مباشر + سبورة";
            document.getElementById('status').classList.replace('bg-red-500', 'bg-green-500');

            // إعداد WebRTC (نفس كود المرة السابقة للربط)
            pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            screenStream.getTracks().forEach(t => pc.addTrack(t, screenStream));
            
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await update(ref(db, 'calls/live'), { offer: { sdp: offer.sdp, type: offer.type } });
        };

        document.getElementById('startStudent').onclick = () => {
            isTeacher = false;
            document.getElementById('drawingTools').classList.add('hidden');
            // منطق استقبال الطالب للفيديو (WebRTC Answer)
        };

    </script>
</body>
</html>