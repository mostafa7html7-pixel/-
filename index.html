<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุตุฉ ูุณุชุฑ ุญูุฏู - ุจุซ ูุจุงุดุฑ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        video { transform: scaleX(1); border-radius: 12px; background: #1a1a1a; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .gradient-bg { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
    </style>
</head>
<body class="gradient-bg text-white min-h-screen font-sans">

    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <div>
                <h1 class="text-4xl font-extrabold text-blue-400">H-Live <span class="text-white text-lg font-light">ุจุซ ุงูุญุตุต ุงููุจุงุดุฑุฉ</span></h1>
                <p id="statusText" class="text-gray-400 mt-2">ุงูุญุงูุฉ: <span class="text-yellow-500 font-bold">ุฌุงูุฒ ููุจุฏุก</span></p>
            </div>
            <div class="flex gap-3">
                <button id="teacherModeBtn" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-full font-bold transition shadow-lg">ุฃูุง ุงููุณุชุฑ</button>
                <button id="studentModeBtn" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-full font-bold transition shadow-lg">ุฃูุง ุทุงูุจ</button>
            </div>
        </div>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="lg:col-span-3 space-y-4">
                <div class="relative group">
                    <video id="mainVideo" autoplay playsinline class="w-full border-2 border-gray-700"></video>
                    <div id="liveBadge" class="absolute top-4 left-4 bg-red-600 text-white px-3 py-1 rounded text-sm font-bold animate-pulse hidden">LIVE ูุจุงุดุฑ</div>
                </div>

                <div id="teacherControls" class="hidden flex flex-wrap gap-4 justify-center bg-gray-800 p-6 rounded-2xl border border-gray-700">
                    <button id="startShare" class="bg-green-600 hover:bg-green-700 px-8 py-3 rounded-xl font-bold flex items-center gap-2 transition">
                        <span>๐</span> ุงุจุฏุฃ ูุดุงุฑูุฉ ุงูุดุงุดุฉ ูุงูุจุซ
                    </button>
                    <button id="stopShare" class="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-xl font-bold hidden transition">
                        <span>๐</span> ุฅููุงุก ูุญูุธ ุงูุญุตุฉ
                    </button>
                </div>

                <div id="studentControls" class="hidden flex justify-center bg-gray-800 p-6 rounded-2xl border border-gray-700">
                    <button id="joinStream" class="bg-blue-600 hover:bg-blue-700 px-10 py-3 rounded-xl font-bold transition animate-bounce">
                        ๐ ุงูุถู ููุญุตุฉ ุงูุขู
                    </button>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700">
                    <h3 class="text-xl font-bold mb-4 text-blue-300">ูุงุฆูุฉ ุงูุญุถูุฑ</h3>
                    <ul id="usersList" class="text-sm space-y-3">
                        <li class="text-gray-500 italic">ูุง ููุฌุฏ ุทูุงุจ ูุชุตููู ุญุงููุงู...</li>
                    </ul>
                </div>
                <div class="bg-blue-900/30 p-5 rounded-2xl border border-blue-800/50">
                    <p class="text-xs text-blue-200 leading-relaxed">
                        ูุตูุญุฉ: ุชุฃูุฏ ูู ุฌูุฏุฉ ุงูุฅูุชุฑูุช ูุฏูู ูุถูุงู ุซุจุงุช ุงูุจุซ ูุตูุช ููู ููุทูุงุจ.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // ุฅุนุฏุงุฏุงุช Firebase ุงูุฎุงุตุฉ ุจู
        const firebaseConfig = {
            apiKey: "AIzaSyCcFRLMsewcgYXYgVvdkyQHf-imoJHHzng",
            authDomain: "mrhamdy-1c406.firebaseapp.com",
            databaseURL: "https://mrhamdy-1c406-default-rtdb.firebaseio.com",
            projectId: "mrhamdy-1c406",
            storageBucket: "mrhamdy-1c406.firebasestorage.app",
            messagingSenderId: "806268398144",
            appId: "1:806268398144:web:c40aef6b378377f72b4da5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // ูุชุบูุฑุงุช ุงูุจุซ
        let peerConnection;
        let localStream;
        let mediaRecorder;
        let recordedChunks = [];
        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

        // 1. ุงุฎุชูุงุฑ ุงููุถุน (ูุณุชุฑ ุฃู ุทุงูุจ)
        document.getElementById('teacherModeBtn').onclick = () => {
            document.getElementById('teacherControls').classList.remove('hidden');
            document.getElementById('studentControls').classList.add('hidden');
            document.getElementById('statusText').innerHTML = "ุงููุถุน ุงูุญุงูู: <span class='text-blue-400'>ูุณุชุฑ (ูุญุงุถุฑ)</span>";
        };

        document.getElementById('studentModeBtn').onclick = () => {
            document.getElementById('studentControls').classList.remove('hidden');
            document.getElementById('teacherControls').classList.add('hidden');
            document.getElementById('statusText').innerHTML = "ุงููุถุน ุงูุญุงูู: <span class='text-purple-400'>ุทุงูุจ (ูุดุงูุฏ)</span>";
        };

        // --- ููุฏ ุงููุณุชุฑ (ุงููุตุฏุฑ) ---
        document.getElementById('startShare').onclick = async () => {
            try {
                // ุงูุชูุงุท ุงูุดุงุดุฉ ูุงูุตูุช
                localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                document.getElementById('mainVideo').srcObject = localStream;
                document.getElementById('liveBadge').classList.remove('hidden');

                // ุจุฏุก ุงูุชุณุฌูู ููุญูุธ
                startRecording(localStream);

                // ุฅูุดุงุก ุงูุบุฑูุฉ ูู Firebase
                const callDoc = ref(db, 'calls/liveSession');
                await remove(callDoc); // ูุณุญ ุฃู ุฌูุณุฉ ุณุงุจูุฉ

                peerConnection = new RTCPeerConnection(servers);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                // ุชุจุงุฏู ุงูู ICE Candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        push(ref(db, 'calls/liveSession/teacherCandidates'), event.candidate.toJSON());
                    }
                };

                const offerDescription = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offerDescription);

                const offer = { sdp: offerDescription.sdp, type: offerDescription.type };
                await update(callDoc, { offer });

                // ุงุณุชูุงุน ูุฑุฏูุฏ ุงูุทูุงุจ
                onValue(ref(db, 'calls/liveSession/answer'), async (snapshot) => {
                    const data = snapshot.val();
                    if (!peerConnection.currentRemoteDescription && data) {
                        const answerDescription = new RTCSessionDescription(data);
                        await peerConnection.setRemoteDescription(answerDescription);
                    }
                });

                document.getElementById('startShare').classList.add('hidden');
                document.getElementById('stopShare').classList.remove('hidden');
            } catch (err) {
                console.error("ุฎุทุฃ ูู ุจุฏุก ุงูุจุซ:", err);
                alert("ูุฑุฌู ุฅุนุทุงุก ุตูุงุญูุฉ ุงููุตูู ููุดุงุดุฉ ูุงูุตูุช");
            }
        };

        // --- ููุฏ ุงูุทุงูุจ (ุงููุณุชูุจู) ---
        document.getElementById('joinStream').onclick = async () => {
            peerConnection = new RTCPeerConnection(servers);
            
            const remoteStream = new MediaStream();
            document.getElementById('mainVideo').srcObject = remoteStream;

            peerConnection.ontrack = (event) => {
                event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
                document.getElementById('liveBadge').classList.remove('hidden');
            };

            const callDoc = ref(db, 'calls/liveSession');
            
            onValue(callDoc, async (snapshot) => {
                const data = snapshot.val();
                if (data && data.offer && !peerConnection.currentRemoteDescription) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answerDescription = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answerDescription);
                    
                    await update(callDoc, { answer: { type: answerDescription.type, sdp: answerDescription.sdp } });
                }
            });

            onChildAdded(ref(db, 'calls/liveSession/teacherCandidates'), (snapshot) => {
                const data = snapshot.val();
                if (data) peerConnection.addIceCandidate(new RTCIceCandidate(data));
            });
        };

        // --- ูุธุงุฆู ุงูุชุณุฌูู ูุงูุญูุธ ---
        function startRecording(stream) {
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8,opus' });
            mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.start();
        }

        document.getElementById('stopShare').onclick = async () => {
            mediaRecorder.stop();
            localStream.getTracks().forEach(track => track.stop());
            document.getElementById('liveBadge').classList.add('hidden');

            mediaRecorder.onstop = async () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const fileName = `lessons/Lesson-${Date.now()}.webm`;
                const storageLink = sRef(storage, fileName);
                
                alert("ุฌุงุฑู ุฑูุน ูุชุณุฌูู ุงูุญุตุฉ... ุงูุชุธุฑ ููููุงู");
                await uploadBytes(storageLink, blob);
                const downloadURL = await getDownloadURL(storageLink);
                
                alert("ุชู ุงูุญูุธ ุจูุฌุงุญ! ูููู ููุทูุงุจ ูุดุงูุฏุฉ ุงูุชุณุฌูู ุนุจุฑ ุงูุฑุงุจุท: " + downloadURL);
                console.log("Video URL:", downloadURL);
                location.reload(); // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุชูุธูู ุงูุงุชุตุงูุงุช
            };
        };

    </script>
</body>
</html>
